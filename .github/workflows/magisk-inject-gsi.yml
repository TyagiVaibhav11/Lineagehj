name: Inject Magisk into Hycon GSI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 📦 Install required tools
        run: |
          sudo apt update
          sudo apt install -y p7zip-full curl zip

      - name: ⬇️ Download GSI from Hycon Release
        run: |
          mkdir gsi && cd gsi
          curl -L -o hycon-gsi.7z "https://github.com/ChonDoit/treble_hycon_patches/releases/download/Roar/LineageOS-21-20240607-UNOFFICIAL-arm64_bvS-vanilla_EROSF.7z"

      - name: 📂 Extract GSI
        run: |
          cd gsi
          7z x hycon-gsi.7z -ogsi-extracted

      - name: ⬇️ Download Magisk v31.0
        run: |
          mkdir magisk && cd magisk
          curl -L -o Magisk-v31.0.apk "https://github.com/topjohnwu/magisk/releases/download/v31.0/Magisk-v31.0.apk"

      - name: 💉 Inject Magisk (simulated)
        run: |
          mkdir workdir
          cp $(find gsi/gsi-extracted -name "*.img" | head -n 1) workdir/system.img
          cp magisk/Magisk-v31.0.apk workdir/magisk.apk

      - name: 📦 Zip modified image
        run: |
          cd workdir
          zip -r ../hycon-magisk.zip .

      - name: 🚀 Upload as New GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: hycon-gsi-magisk-${{ github.run_id }}
          name: Hycon GSI with Magisk v31.0 - Build ${{ github.run_number }}
          body: |
            This is an auto-generated build with Magisk v31.0 injected into the Hycon GSI.
            Base source: https://github.com/ChonDoit/treble_hycon_patches/releases/tag/Roar
          files: hycon-magisk.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 🧹 Clean up
        run: rm -rf gsi magisk workdir hycon-magisk.zip
        
