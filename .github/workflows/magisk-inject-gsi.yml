name: Create Flashable Hycon GSI with Magisk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¦ Install required tools
        run: |
          sudo apt update
          sudo apt install -y curl zip

      - name: â¬‡ï¸ Download GSI Image
        run: |
          mkdir gsi
          cd gsi
          curl -L -o system.img "https://github.com/ChonDoit/treble_hycon_patches/releases/download/Roar/LineageOS-21-20240607-UNOFFICIAL-arm64_bvS-vanilla_EROSF.img"

      - name: â¬‡ï¸ Download Magisk v31.0
        run: |
          mkdir magisk
          cd magisk
          curl -L -o magisk.apk "https://github.com/topjohnwu/magisk/releases/download/v31.0/Magisk-v31.0.apk"

      - name: ðŸ—ï¸ Build flashable ZIP structure
        run: |
          mkdir -p flashable/META-INF/com/google/android
          cp gsi/system.img flashable/system.img
          cp magisk/magisk.apk flashable/magisk.apk

          # Create dummy updater-script
          echo 'ui_print("Flashing GSI...");' > flashable/META-INF/com/google/android/updater-script
          echo 'package_extract_file("system.img", "/dev/block/bootdevice/by-name/system");' >> flashable/META-INF/com/google/android/updater-script
          echo 'ui_print("GSI Flash complete.");' >> flashable/META-INF/com/google/android/updater-script

      - name: ðŸ“¦ Zip the flashable package
        run: |
          cd flashable
          zip -r ../hycon-gsi-magisk-flashable.zip .

      - name: ðŸš€ Upload to New GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: hycon-gsi-magisk-${{ github.run_id }}
          name: Hycon Flashable GSI + Magisk v31.0
          body: |
            Flashable Hycon GSI with Magisk v31.0
            Built from: https://github.com/ChonDoit/treble_hycon_patches/releases/tag/Roar
          files: hycon-gsi-magisk-flashable.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§¹ Clean up
        run: rm -rf gsi magisk flashable hycon-gsi-magisk-flashable.zip
        
