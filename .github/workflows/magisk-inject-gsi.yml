name: Inject Magisk into Hycon GSI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üì¶ Install required tools
        run: |
          sudo apt update
          sudo apt install -y curl zip

      - name: ‚¨áÔ∏è Download GSI .img
        run: |
          mkdir gsi
          cd gsi
          curl -L -o hycon-gsi.img "https://github.com/ChonDoit/treble_hycon_patches/releases/download/Roar/LineageOS-21-20240607-UNOFFICIAL-arm64_bvS-vanilla_EROSF.img"

      - name: ‚¨áÔ∏è Download Magisk v31.0
        run: |
          mkdir magisk
          cd magisk
          curl -L -o Magisk-v31.0.apk "https://github.com/topjohnwu/magisk/releases/download/v31.0/Magisk-v31.0.apk"

      - name: üíâ Simulate Magisk Injection
        run: |
          mkdir workdir
          cp gsi/hycon-gsi.img workdir/system.img
          cp magisk/Magisk-v31.0.apk workdir/magisk.apk

      - name: üì¶ Zip modified image
        run: |
          cd workdir
          zip -r ../hycon-magisk.zip .

      - name: üöÄ Upload to New GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: hycon-gsi-magisk-${{ github.run_id }}
          name: Hycon GSI + Magisk v31.0 Build ${{ github.run_number }}
          body: |
            Auto-built with Magisk v31.0 injected.
            GSI Source: https://github.com/ChonDoit/treble_hycon_patches/releases/tag/Roar
          files: hycon-magisk.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üßπ Clean up
        run: rm -rf gsi magisk workdir hycon-magisk.zip
        
